# Metricx Data Models

> Auto-generated by BMad Document-Project workflow on 2025-12-11

## Overview

Metricx uses PostgreSQL with SQLAlchemy ORM. All models use UUID primary keys and explicit relationships. The schema is organized into domains:

- **Core:** Users, Workspaces, Connections
- **Ad Metrics:** Entities, Snapshots, P&L
- **E-commerce:** Shopify models
- **Attribution:** Pixel events, Journeys

## Entity Relationship Diagram

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Workspace  │────<│    User     │     │    Token    │
│             │     │             │     │             │
│ • id (PK)   │     │ • id (PK)   │     │ • id (PK)   │
│ • name      │     │ • clerk_id  │     │ • provider  │
│ • last_sync │     │ • email     │     │ • access_*  │
└──────┬──────┘     │ • role      │     │ • refresh_* │
       │            └─────────────┘     └──────┬──────┘
       │                                       │
       ├───────────────────────────────────────┤
       │                                       │
       ▼                                       ▼
┌─────────────┐                         ┌─────────────┐
│ Connection  │─────────────────────────│   Entity    │
│             │                         │             │
│ • id (PK)   │                         │ • id (PK)   │
│ • provider  │                         │ • level     │
│ • status    │                         │ • name      │
│ • token_id  │                         │ • goal      │
└─────────────┘                         └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │MetricSnapshot│
                                        │             │
                                        │ • id (PK)   │
                                        │ • spend     │
                                        │ • revenue   │
                                        │ • clicks    │
                                        └─────────────┘
```

## Core Models

### Workspace
Multi-tenant container for all resources.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| name | String | Workspace name |
| created_at | DateTime | Creation timestamp |
| last_synced_at | DateTime | Last successful sync |

**Relationships:** users, memberships, connections, entities, queries

### User
Person who can access the system.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| clerk_id | String | Clerk user ID (unique) |
| email | String | Email address (unique) |
| name | String | Display name |
| role | Enum | Owner, Admin, Viewer |
| workspace_id | UUID | Active workspace (FK) |

### Connection
Link to an advertising platform account.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| provider | Enum | google, meta, shopify |
| external_account_id | String | Platform account ID |
| status | String | active, paused, disconnected |
| sync_frequency | String | 15min, 30min, hourly, daily |
| workspace_id | UUID | Owning workspace (FK) |
| token_id | UUID | Auth token (FK) |

## Ad Metrics Models

### Entity
Marketing entity (campaign, ad set, ad).

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| level | Enum | account, campaign, adset, ad |
| external_id | String | Platform entity ID |
| name | String | Entity name |
| status | String | active, paused, etc. |
| goal | Enum | awareness, traffic, leads, purchases |
| parent_id | UUID | Parent entity (FK) |
| workspace_id | UUID | Owning workspace (FK) |
| connection_id | UUID | Source connection (FK) |

### MetricSnapshot
15-minute granularity ad metrics.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| entity_id | UUID | Associated entity (FK) |
| provider | String | meta, google |
| captured_at | DateTime | Snapshot timestamp |
| spend | Decimal | Ad spend |
| impressions | BigInt | Impression count |
| clicks | BigInt | Click count |
| conversions | Decimal | Conversion count |
| revenue | Decimal | Attributed revenue |
| leads | Decimal | Lead count |
| purchases | Integer | Purchase count |

**Note:** Replaces deprecated `MetricFact` table.

### Pnl (Profit & Loss)
Snapshot/EOD aggregations with derived metrics.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| entity_id | UUID | Associated entity (FK) |
| kind | Enum | snapshot, eod |
| event_date | DateTime | Report date |
| spend | Decimal | Total spend |
| revenue | Decimal | Total revenue |
| cpc | Decimal | Cost per click |
| cpm | Decimal | Cost per mille |
| roas | Decimal | Return on ad spend |
| ctr | Decimal | Click-through rate |

## Shopify Models

### ShopifyShop
Shopify store metadata.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| workspace_id | UUID | Owning workspace (FK) |
| connection_id | UUID | Connection (FK, unique) |
| shop_domain | String | e.g., "store.myshopify.com" |
| currency | String | ISO currency code |
| timezone | String | IANA timezone |

### ShopifyOrder
Order with attribution data.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| shop_id | UUID | Parent shop (FK) |
| customer_id | UUID | Customer (FK, nullable) |
| external_order_id | String | Shopify order ID |
| total_price | Decimal | Order total |
| financial_status | Enum | pending, paid, refunded |
| utm_source | String | Attribution source |
| utm_campaign | String | Campaign name |
| checkout_token | String | For journey linking |

### ShopifyCustomer
Customer with LTV metrics.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| shop_id | UUID | Parent shop (FK) |
| email | String | Customer email |
| total_spent | Decimal | Lifetime value |
| order_count | Integer | Order count |
| first_order_at | DateTime | First purchase |

### ShopifyProduct
Product catalog with COGS.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| shop_id | UUID | Parent shop (FK) |
| title | String | Product title |
| price | Decimal | Primary variant price |
| cost_per_item | Decimal | COGS for profit calc |

## Attribution Models

### PixelEvent
Raw event log from web pixel (immutable).

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| workspace_id | UUID | Workspace (FK) |
| visitor_id | String | Browser visitor ID |
| event_type | String | page_view, checkout_completed |
| utm_source | String | Traffic source |
| fbclid | String | Facebook click ID |
| gclid | String | Google click ID |
| landing_page | String | Entry URL |

### CustomerJourney
Tracks visitors across sessions.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| workspace_id | UUID | Workspace (FK) |
| visitor_id | String | Visitor ID (unique per workspace) |
| first_touch_source | String | First attribution |
| last_touch_source | String | Latest attribution |
| touchpoint_count | Integer | Total touchpoints |
| total_orders | Integer | Converted orders |
| total_revenue | Decimal | Total revenue |

### Attribution
Final attribution linking orders to entities.

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| workspace_id | UUID | Workspace (FK) |
| journey_id | UUID | Customer journey (FK) |
| shopify_order_id | UUID | Order (FK) |
| entity_id | UUID | Attributed entity (FK) |
| provider | String | meta, google, direct |
| match_type | String | gclid, utm_campaign, etc. |
| confidence | String | high, medium, low |
| attributed_revenue | Decimal | Revenue amount |

## Enums

### ProviderEnum
```python
google, meta, tiktok, shopify, other
```

### LevelEnum
```python
account, campaign, adset, ad, asset_group, product
```

### GoalEnum
```python
awareness, traffic, leads, app_installs, purchases, conversions, other
```

### RoleEnum
```python
Owner, Admin, Viewer
```

## Migrations

Migrations managed via Alembic in `backend/alembic/versions/`.

```bash
# Create migration
alembic revision --autogenerate -m "description"

# Apply migrations
alembic upgrade head

# Check current
alembic current
```
