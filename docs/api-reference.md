# Metricx API Reference

> Auto-generated by BMad Document-Project workflow on 2025-12-11

## Overview

The Metricx API is a REST API built with FastAPI. Authentication uses Clerk JWT tokens stored in HTTP-only cookies.

**Base URLs:**
- Development: `http://localhost:8000`
- Production: `https://api.metricx.ai`

## Authentication

All protected endpoints require a valid JWT token from Clerk.

```
Cookie: access_token=Bearer <jwt_token>
```

Public endpoints: `/health`, `/auth/register`, `/auth/login`

## Endpoints by Category

### Health Check

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/health` | Service health check |

### Authentication (`/auth/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/auth/register` | Register new user |
| POST | `/auth/login` | Login (returns JWT) |
| POST | `/auth/logout` | Logout (clears cookie) |
| GET | `/auth/me` | Get current user |

### Workspaces (`/workspaces/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/workspaces` | List user's workspaces |
| POST | `/workspaces` | Create workspace |
| GET | `/workspaces/{id}` | Get workspace details |
| PUT | `/workspaces/{id}` | Update workspace |
| DELETE | `/workspaces/{id}` | Delete workspace |

### Connections (`/connections/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/connections` | List workspace connections |
| POST | `/connections` | Create connection |
| GET | `/connections/{id}` | Get connection details |
| DELETE | `/connections/{id}` | Delete connection |

### Entities (`/entities/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/entities` | List entities (campaigns, ads) |
| GET | `/entities/{id}` | Get entity details |
| GET | `/entities/{id}/children` | Get child entities |
| GET | `/entities/{id}/metrics` | Get entity metrics |

### Dashboard (`/dashboard/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/dashboard/unified` | All dashboard data in one call |
| GET | `/dashboard/kpis` | KPI metrics |

**Query Parameters:**
- `timeframe`: `today`, `yesterday`, `last_7_days`, `last_30_days`, `this_month`
- `provider`: `meta`, `google`, `all`

### Analytics (`/analytics/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/analytics/charts` | Chart data for analytics page |
| GET | `/analytics/breakdown` | Platform breakdown data |

### AI Copilot (`/qa/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/qa/agent/sse` | SSE streaming (recommended) |
| POST | `/qa/agent/sync` | Synchronous response |
| POST | `/qa/semantic` | Direct semantic layer access |
| POST | `/qa/insights` | Lightweight insights |
| GET | `/qa/history` | Query history |
| POST | `/qa/feedback` | Submit answer feedback |

**Request Body (SSE/Sync):**
```json
{
  "question": "What's my CPC this week?",
  "workspace_id": "uuid"
}
```

**SSE Response Events:**
```
data: {"type": "token", "data": "Your"}
data: {"type": "token", "data": " CPC"}
data: {"type": "chart", "data": {...}}
data: {"type": "done"}
```

### Finance (`/finance/*`, `/pnl/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/pnl` | P&L report |
| GET | `/finance/manual-costs` | List manual costs |
| POST | `/finance/manual-costs` | Add manual cost |
| PUT | `/finance/manual-costs/{id}` | Update manual cost |
| DELETE | `/finance/manual-costs/{id}` | Delete manual cost |

### OAuth Flows

#### Meta OAuth (`/auth/meta/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/auth/meta/authorize` | Start OAuth flow |
| GET | `/auth/meta/callback` | OAuth callback |
| GET | `/auth/meta/accounts` | List ad accounts |

#### Google OAuth (`/auth/google/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/auth/google/authorize` | Start OAuth flow |
| GET | `/auth/google/callback` | OAuth callback |
| GET | `/auth/google/accounts` | List ad accounts |

#### Shopify OAuth (`/auth/shopify/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/auth/shopify/authorize` | Start OAuth flow |
| GET | `/auth/shopify/callback` | OAuth callback |
| GET | `/auth/shopify/shops` | List shops |

### Sync (`/sync/*`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/sync/meta/{connection_id}` | Trigger Meta sync |
| POST | `/sync/google/{connection_id}` | Trigger Google sync |
| POST | `/sync/shopify/{connection_id}` | Trigger Shopify sync |
| GET | `/sync/status/{connection_id}` | Get sync status |

### Attribution (`/attribution/*`, `/v1/pixel-events`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/v1/pixel-events` | Receive pixel events |
| GET | `/attribution/health` | Pixel health status |
| GET | `/attribution/journeys` | Customer journeys |
| GET | `/attribution/orders` | Attributed orders |

**Pixel Event Body:**
```json
{
  "workspace_id": "uuid",
  "visitor_id": "string",
  "event_type": "page_view",
  "event_data": {},
  "utm_source": "facebook",
  "fbclid": "string"
}
```

### Webhooks

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/webhooks/clerk` | Clerk user events |
| POST | `/webhooks/shopify/orders/create` | Order created |
| POST | `/webhooks/shopify/customers/redact` | GDPR redact |
| POST | `/webhooks/shopify/shop/redact` | Shop data redact |

## Error Responses

```json
{
  "detail": "Error message",
  "status_code": 400
}
```

| Code | Description |
|------|-------------|
| 400 | Bad request / validation error |
| 401 | Unauthorized (missing/invalid token) |
| 403 | Forbidden (insufficient permissions) |
| 404 | Resource not found |
| 422 | Validation error |
| 500 | Internal server error |

## Rate Limiting

- API rate limits handled per-connection
- When `429` returned, `rate_limited_until` set on connection
- Sync jobs skip rate-limited connections

## OpenAPI Schema

Interactive docs available at:
- Swagger UI: `{base_url}/docs`
- ReDoc: `{base_url}/redoc`
