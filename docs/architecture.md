# Metricx Architecture Documentation

> Auto-generated by BMad Document-Project workflow on 2025-12-11

## Overview

Metricx is an AI-powered marketing analytics platform that helps merchants understand and optimize their ad spend. The platform competes with Triple Whale with a clearer focus on ad analytics first, attribution second.

**North Star:** Natural language → Precise insights. No learning curve.

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              METRICX PLATFORM                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────────────────┐
│    Frontend     │     │     Backend     │     │      Background Jobs        │
│   (Next.js)     │────▶│   (FastAPI)     │────▶│      (ARQ Workers)          │
│   Port 3000     │     │   Port 8000     │     │                             │
│                 │     │                 │     │                             │
│ • Dashboard     │     │ • REST API      │     │ • 15-min metric sync        │
│ • Analytics     │     │ • Clerk Auth    │     │ • Daily attribution sync    │
│ • Copilot (AI)  │     │ • Semantic QA   │     │ • Snapshot compaction       │
│ • Campaigns     │     │ • Unified API   │     │ • Shopify sync              │
│ • Finance       │     │ • SSE Streaming │     │ • QA processing             │
└─────────────────┘     └────────┬────────┘     └─────────────────────────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        ▼                        ▼                        ▼
┌───────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  PostgreSQL   │      │     Redis       │      │  External APIs  │
│               │      │                 │      │                 │
│ • Users       │      │ • ARQ queues    │      │ • Meta Ads      │
│ • Workspaces  │      │ • Job results   │      │ • Google Ads    │
│ • Entities    │      │ • JWKS cache    │      │ • Shopify       │
│ • Snapshots   │      │ • SSE streams   │      │ • Anthropic     │
│ • Attribution │      │                 │      │ • Clerk         │
└───────────────┘      └─────────────────┘      └─────────────────┘
```

## Project Structure

| Part | Type | Technology | Purpose |
|------|------|------------|---------|
| `backend/` | Backend API | Python/FastAPI | REST API, business logic, AI agent |
| `ui/` | Web Frontend | Next.js 15/React 19 | Dashboard, analytics, copilot UI |
| `shopify-app/` | Extension | Shopify CLI | E-commerce integration |

## Technology Stack

### Backend (Python)
- **Framework:** FastAPI 0.115
- **ORM:** SQLAlchemy 2.0 + asyncpg
- **Database:** PostgreSQL 16
- **Migrations:** Alembic
- **Queue:** ARQ (Redis-based async)
- **AI:** Anthropic Claude + LangGraph
- **Observability:** Sentry, Langfuse, RudderStack

### Frontend (JavaScript)
- **Framework:** Next.js 15.5 (App Router)
- **UI:** React 19, Tailwind CSS 4, shadcn/ui
- **Auth:** Clerk
- **Charts:** Recharts, Chart.js
- **Testing:** Vitest, Testing Library

### Infrastructure
- **Container:** Docker (multi-stage builds)
- **Orchestration:** Docker Compose
- **Deployment:** Defang
- **Hosting:** PostgreSQL (Railway), Redis (Upstash)

## Data Model

### Core Entities (26 tables)

```
Workspace (1) ──┬── User (N)
                ├── Connection (N) ── Token (1)
                ├── Entity (N) ── MetricSnapshot (N)
                ├── ShopifyShop (1) ──┬── ShopifyProduct (N)
                │                     ├── ShopifyCustomer (N)
                │                     └── ShopifyOrder (N)
                └── CustomerJourney (N) ── Attribution (N)
```

### Key Models
- **Workspace:** Multi-tenant container for all resources
- **Connection:** Link to ad platform accounts (Meta, Google, Shopify)
- **Entity:** Campaign hierarchy (Account → Campaign → AdSet → Ad)
- **MetricSnapshot:** 15-minute granularity ad metrics
- **Attribution:** Order-to-campaign attribution records

## API Architecture

### Route Categories (23 modules)

| Category | Endpoints |
|----------|-----------|
| **Auth** | `/auth/*`, `/webhooks/clerk` |
| **Core** | `/workspaces/*`, `/connections/*`, `/entities/*` |
| **Metrics** | `/metrics/*`, `/kpis/*`, `/dashboard/*`, `/analytics/*` |
| **AI** | `/qa/*` (SSE streaming, sync, semantic) |
| **Finance** | `/pnl/*`, `/finance/*` |
| **OAuth** | `/auth/meta/*`, `/auth/google/*`, `/auth/shopify/*` |
| **Sync** | `/sync/meta/*`, `/sync/google/*`, `/sync/shopify/*` |
| **Attribution** | `/v1/pixel-events`, `/attribution/*` |

### Authentication Flow
1. User authenticates via Clerk (OAuth or email/password)
2. Clerk issues RS256 JWT token
3. Backend validates JWT using Clerk's JWKS endpoint
4. User ID extracted from `sub` claim, mapped to local user

## AI Copilot Architecture

### Question → Answer Flow

```
User: "Compare CPC this week vs last week for top 3 ads"
       ↓
[understand_node] Claude extracts intent → SemanticQuery
       ↓
[fetch_data_node] Semantic Layer → UnifiedMetricService
       ↓
[respond_node] Claude generates answer + visuals
       ↓
SSE Stream: tokens + chart spec + done event
```

### Semantic Layer
Composable query structure supporting:
- **Metrics:** 24 metrics (CPC, ROAS, CTR, etc.)
- **Breakdowns:** By entity, provider, time
- **Comparisons:** Previous period, custom ranges
- **Timeseries:** Trend data for charts

## Background Processing

### ARQ Worker Jobs
- **sync_meta_metrics:** Fetch Meta Ads data
- **sync_google_metrics:** Fetch Google Ads data
- **sync_shopify_orders:** Fetch Shopify orders
- **process_qa_query:** Handle AI queries (async)

### Scheduled Tasks
- Every 15 min: Sync today's metrics
- Daily 1am: Compact 15-min → hourly
- Daily 3am: Re-fetch last 7 days (attribution corrections)

## Security

### Token Encryption
- OAuth tokens encrypted with AES-256-GCM
- Encryption key in `TOKEN_ENCRYPTION_KEY` env var
- Tokens stored in separate `tokens` table

### Data Isolation
- All queries scoped by `workspace_id`
- SQL-level multi-tenancy
- No cross-workspace data access

## Observability

| Tool | Purpose |
|------|---------|
| **Sentry** | Error tracking, performance monitoring |
| **Langfuse** | LLM call tracing, token usage, costs |
| **RudderStack** | User analytics → GA4 |

## Development

### Quick Start
```bash
# Backend
cd backend
python -m venv venv && source venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
python start_api.py

# Worker
arq app.workers.arq_worker.WorkerSettings

# Frontend
cd ui
npm install && npm run dev
```

### Deployment
```bash
defang compose up
```

## Related Documentation

- [AUTH.md](../docs-arch/living-docs/AUTH.md) - Clerk authentication
- [ARQ_WORKERS.md](../docs-arch/living-docs/ARQ_WORKERS.md) - Background jobs
- [QA_SYSTEM_ARCHITECTURE.md](../docs-arch/living-docs/QA_SYSTEM_ARCHITECTURE.md) - AI Copilot
- [METRIC_SNAPSHOTS.md](../docs-arch/living-docs/METRIC_SNAPSHOTS.md) - 15-min sync
